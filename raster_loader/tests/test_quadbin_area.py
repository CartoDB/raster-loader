import pytest

from raster_loader.quadbinarea import quadbin_area_zy


# Test data generated with this BigQuery query:
# WITH zs AS (
#    SELECT * FROM unnest(generate_array(0, 22)) AS z
# ),
# z_ys AS (
#   SELECT z, y
#   FROM zs, unnest(generate_array(0, (1 << z) - 1, IF(z>4, (1 << (z - 3)) ,1))) AS y
# )
# SELECT z, y, ST_AREA(
#   `carto-un`.carto.QUADBIN_BOUNDARY(`carto-un`.carto.QUADBIN_FROMZXY(z,0,y))
# )
# FROM z_ys
expected_results = [
    # z  y  area
    (0, 0, 508164597540055.75),
    (1, 0, 127516518279497.16),
    (1, 1, 127516518279497.11),
    (2, 0, 3354306636925.9023),
    (2, 1, 60252354543011.562),
    (2, 2, 60252354543011.562),
    (2, 3, 3354306636925.9019),
    (3, 0, 405347921787.11267),
    (3, 1, 1893932149859.4053),
    (3, 2, 7940839890420.5068),
    (3, 3, 21531954963610.305),
    (3, 4, 21531954963610.305),
    (3, 5, 7940839890420.51),
    (3, 6, 1893932149859.4014),
    (3, 7, 405347921787.11371),
    (4, 0, 68847216295.911758),
    (4, 1, 150015920630.08636),
    (4, 2, 324359672843.66473),
    (4, 3, 689700245764.47681),
    (4, 4, 1415535456168.1387),
    (4, 5, 2703138561407.3833),
    (4, 6, 4507012722233.37),
    (4, 7, 6023040823252.668),
    (4, 8, 6023040823252.6641),
    (4, 9, 4507012722233.373),
    (4, 10, 2703138561407.3848),
    (4, 11, 1415535456168.1404),
    (4, 12, 689700245764.47473),
    (4, 13, 324359672843.66516),
    (4, 14, 150015920630.08661),
    (4, 15, 68847216295.912216),
    (5, 0, 14160505713.702057),
    (5, 4, 66957044671.406059),
    (5, 8, 297109634630.50342),
    (5, 12, 1008646311011.379),
    (5, 16, 1549853128285.9084),
    (5, 20, 780011091373.6311),
    (5, 24, 207289317396.88107),
    (5, 28, 45530712164.630028),
    (6, 0, 3210498445.8824654),
    (6, 8, 15204878147.827898),
    (6, 16, 67965167366.128731),
    (6, 24, 237461340707.57086),
    (6, 32, 390274232638.22693),
    (6, 40, 208783733329.56433),
    (6, 48, 56765895703.366409),
    (6, 56, 12538056116.820728),
    (7, 0, 764328456.28678691),
    (7, 16, 3622540506.9648323),
    (7, 32, 16248126209.176235),
    (7, 48, 57545410795.202972),
    (7, 64, 97745045568.055634),
    (7, 80, 53957641045.313591),
    (7, 96, 14849099728.531345),
    (7, 112, 3289546290.2144575),
    (8, 0, 186467048.65355381),
    (8, 32, 884078744.69014585),
    (8, 64, 3971905493.8171182),
    (8, 96, 14160339910.8699),
    (8, 128, 24447304143.76936),
    (8, 160, 13711772787.766005),
    (8, 192, 3797054754.548408),
    (8, 224, 842465672.81052923),
    (9, 0, 46050330.23509074),
    (9, 64, 218372534.04884157),
    (9, 128, 981880701.56478),
    (9, 192, 3511936869.1768293),
    (9, 256, 6112516398.9001732),
    (9, 320, 3455862981.7418623),
    (9, 384, 960025220.6932801),
    (9, 448, 213171250.23417619),
    (10, 0, 11442422.668480542),
    (10, 128, 54265162.877770752),
    (10, 256, 244093752.50473356),
    (10, 384, 874472509.61802387),
    (10, 512, 1528172250.3897524),
    (10, 640, 867463180.03068376),
    (10, 768, 241361844.3184481),
    (10, 896, 53615013.343808956),
    (11, 0, 2851875.6549530826),
    (11, 256, 13525475.896024764),
    (11, 512, 60852040.826949552),
    (11, 768, 218179599.71270698),
    (11, 1024, 382045759.56053209),
    (11, 1280, 217303430.58745173),
    (11, 1536, 60510553.144992881),
    (11, 1792, 13444207.546244394),
    (12, 0, 711880.15181728092),
    (12, 512, 3376278.4276601188),
    (12, 1024, 15191626.424900804),
    (12, 1536, 54490111.524707869),
    (12, 2048, 95511608.451035544),
    (12, 2560, 54380590.292608134),
    (12, 3072, 15148940.490946993),
    (12, 3584, 3366119.8946256591),
    (13, 0, 177834.09803959142),
    (13, 1024, 843433.9941112136),
    (13, 2048, 3795236.1856589988),
    (13, 3072, 13615681.063173439),
    (13, 4096, 23877912.647832859),
    (13, 5120, 13601990.906296989),
    (13, 6144, 3789900.44473846),
    (13, 7168, 842164.17781747109),
    (14, 0, 44441.5417196901),
    (14, 2048, 210779.09098281202),
    (14, 4096, 948475.40326192416),
    (14, 6144, 3403064.5221314919),
    (14, 8192, 5969478.8203979144),
    (14, 10240, 3401353.2524307016),
    (14, 12288, 947808.43567256245),
    (14, 14336, 210620.36395806741),
    (15, 0, 11108.263187119439),
    (15, 4096, 52684.849555321867),
    (15, 8192, 237077.15538302113),
    (15, 12288, 850659.16937331774),
    (15, 16384, 1492369.7462518667),
    (15, 20480, 850445.26065634191),
    (15, 24576, 236993.78443494561),
    (15, 28672, 52665.008678005943),
    (16, 0, 2776.8005542784613),
    (16, 8192, 13169.972161726404),
    (16, 16384, 59264.077539137535),
    (16, 24576, 212651.42262138167),
    (16, 32768, 373092.43913406151),
    (16, 40960, 212624.68403330541),
    (16, 49152, 59253.65617023244),
    (16, 57344, 13167.492052404968),
    (17, 0, 694.16698562804572),
    (17, 16384, 3292.33802293761),
    (17, 32768, 14815.368009842998),
    (17, 49152, 53161.184467270112),
    (17, 65536, 93273.109944496027),
    (17, 81920, 53157.842143342983),
    (17, 98304, 14814.065339102703),
    (17, 114688, 3292.0280091507925),
    (18, 0, 173.53760240416173),
    (18, 32768, 823.06512921555191),
    (18, 65536, 3703.7605831585784),
    (18, 98304, 13290.08721953591),
    (18, 131072, 23318.277496005037),
    (18, 163840, 13289.669429339378),
    (18, 196608, 3703.5977492433658),
    (18, 229376, 823.02637753244517),
    (19, 0, 43.383882619639188),
    (19, 65536, 205.76386028347031),
    (19, 131072, 925.92996850427335),
    (19, 196608, 3322.4956929142404),
    (19, 262144, 5829.5693745498947),
    (19, 327680, 3322.4434690965386),
    (19, 393216, 925.90961426734134),
    (19, 458752, 205.75901633678478),
    (20, 0, 10.845905913090053),
    (20, 131072, 51.440662297569574),
    (20, 262144, 231.48121997891653),
    (20, 393216, 830.6206592040279),
    (20, 524288, 1457.3923436601747),
    (20, 655360, 830.61413121845987),
    (20, 786432, 231.47867569299893),
    (20, 917504, 51.4400568296431),
    (21, 0, 2.7114683806069366),
    (21, 262144, 12.860127728127763),
    (21, 524288, 57.870145962517341),
    (21, 786432, 207.6547568007845),
    (21, 1048576, 364.34808589465348),
    (21, 1310720, 207.65394082474009),
    (21, 1572864, 57.86982793356335),
    (21, 1835008, 12.860052049235128),
    (22, 0, 0.67786608211461929),
    (22, 524288, 3.2150272015737071),
    (22, 1048576, 14.467516611460995),
    (22, 1572864, 51.913638191703392),
    (22, 2097152, 91.087021479016386),
    (22, 2621440, 51.913536203684849),
    (22, 3145728, 14.4674768633863),
    (22, 3670016, 3.2150177453530335),
]


def test_quadbin_area_zy():
    for z, y, area in expected_results:
        assert quadbin_area_zy(z, y) == pytest.approx(area, rel=1.5e-1)
